

# แผนการนำเข้าข้อมูลงบประมาณจากไฟล์ Excel

## สรุปข้อมูลจากไฟล์ Excel
ไฟล์มีข้อมูลงบประมาณจาก **75 หน่วยงาน** (โรงพยาบาลและ สสจ.) แยกตาม 17 หมวดหมู่ CTAM โดยมีโครงสร้างดังนี้:

| คอลัมน์ | ข้อมูล |
|---------|--------|
| โรงพยาบาล | ชื่อหน่วยงาน (เช่น รพ.ดอยหลวง, สสจ. พะเยา) |
| จังหวัด | จังหวัดที่ตั้ง |
| คอลัมน์ 3-19 | งบประมาณ 17 หมวดหมู่ CTAM |

---

## ความท้าทาย: การจับคู่ชื่อหน่วยงาน

ชื่อในไฟล์ Excel กับฐานข้อมูลมีความแตกต่าง เช่น:

| Excel | Database |
|-------|----------|
| `รพ.ดอยหลวง` | `รพ.ดอยหลวง` ✓ (ตรงกัน) |
| `สสจ. พะเยา` | `สำนักงานสาธารณสุขจังหวัดพะเยา` ✗ (ต้อง fuzzy match) |
| `สนง.เขต` | `สำนักงานเขตสุขภาพที่ 1` ✗ (ต้องระบุเพิ่ม) |

---

## สิ่งที่ต้องทำ

### 1. สร้าง Edge Function สำหรับนำเข้าข้อมูล
สร้าง edge function ที่:
- รับไฟล์ Excel และ fiscal_year
- Parse ข้อมูลจาก Excel
- จับคู่ชื่อหน่วยงานกับฐานข้อมูล (Fuzzy Matching)
- Insert/Update ข้อมูลลงตาราง `budget_records`

### 2. เพิ่มปุ่ม "นำเข้าข้อมูล" ในหน้า BudgetRecording หรือ BudgetReport
- สำหรับ central_admin หรือ regional เท่านั้น
- เลือกไฟล์ Excel และปีงบประมาณ
- แสดง preview ก่อนนำเข้า
- รายงานผลการจับคู่

### 3. Algorithm สำหรับ Fuzzy Matching
```text
1. ทำให้ชื่อเป็นมาตรฐาน:
   - "สสจ." → "สำนักงานสาธารณสุขจังหวัด"
   - "รพ." → "รพ."
   - ลบช่องว่างพิเศษ

2. จับคู่แบบ Exact Match ก่อน

3. ถ้าไม่ตรง ใช้ Fuzzy Match:
   - คำนวณ Levenshtein distance
   - เลือกที่ใกล้เคียงที่สุดและ > 80% similarity

4. ใช้ข้อมูลจังหวัดช่วย validate
```

---

## สิ่งที่จะสร้าง/แก้ไข

| ไฟล์ | การดำเนินการ |
|------|-------------|
| `supabase/functions/import-budget/index.ts` | สร้างใหม่ - Edge function สำหรับ import |
| `src/pages/BudgetRecording.tsx` หรือ `BudgetReport.tsx` | เพิ่มปุ่มนำเข้า |
| `src/components/budget/BudgetImportDialog.tsx` | สร้างใหม่ - Dialog สำหรับ import |

---

## รายละเอียด Edge Function

### Input
```json
{
  "fiscal_year": 2568,
  "data": [
    {
      "unit_name": "รพ.ดอยหลวง",
      "province": "เชียงราย", 
      "budgets": {
        "BACKUP": 0,
        "ANTIVIRUS": 10000,
        ...
      }
    }
  ]
}
```

### Output
```json
{
  "success": true,
  "imported": 70,
  "failed": 5,
  "unmatched": [
    {"unit_name": "สนง.เขต", "reason": "ไม่พบหน่วยงานที่ตรงกัน"}
  ],
  "matched": [
    {"unit_name": "สสจ. พะเยา", "matched_to": "สำนักงานสาธารณสุขจังหวัดพะเยา"}
  ]
}
```

---

## การทำงานของ Fuzzy Matching

### ขั้นตอน Normalize ชื่อ
```text
Input: "สสจ. พะเยา"
Step 1: Replace "สสจ." → "สำนักงานสาธารณสุขจังหวัด"
Step 2: Remove extra spaces
Output: "สำนักงานสาธารณสุขจังหวัดพะเยา"
→ Exact match ✓

Input: "สนง.เขต" + จังหวัด "เชียงใหม่"
Step 1: Recognize as regional office
Step 2: Match to "สำนักงานเขตสุขภาพที่ 1" (based on เชียงใหม่ = เขต 1)
→ Matched ✓
```

---

## UI สำหรับการ Import

```text
┌─────────────────────────────────────────────────┐
│ นำเข้าข้อมูลงบประมาณ                              │
├─────────────────────────────────────────────────┤
│                                                 │
│ ปีงบประมาณ: [2568 ▼]                            │
│                                                 │
│ ไฟล์ Excel: [เลือกไฟล์...]                       │
│                                                 │
│ ┌───────────────────────────────────────────┐   │
│ │ Preview (แสดง 5 รายการแรก)                 │   │
│ │ ─────────────────────────────────────────  │   │
│ │ ✓ รพ.ดอยหลวง → รพ.ดอยหลวง                 │   │
│ │ ✓ สสจ. พะเยา → สำนักงานสาธารณสุข...       │   │
│ │ ⚠ สนง.เขต → สำนักงานเขตสุขภาพที่ 1?       │   │
│ └───────────────────────────────────────────┘   │
│                                                 │
│ สรุป: จับคู่ได้ 70/75 หน่วยงาน                   │
│                                                 │
│        [ยกเลิก]         [นำเข้าข้อมูล]           │
└─────────────────────────────────────────────────┘
```

---

## ขั้นตอนการ Implement

1. สร้าง Edge Function `import-budget` พร้อม fuzzy matching logic
2. สร้าง `BudgetImportDialog.tsx` component สำหรับ UI
3. เพิ่มปุ่มนำเข้าในหน้า `BudgetRecording.tsx` (สำหรับ central_admin)
4. Parse Excel client-side ด้วย `xlsx` library (มีอยู่แล้ว)
5. ส่งข้อมูลไป Edge Function เพื่อ match และ insert
6. แสดงผลลัพธ์การนำเข้า

